%% Pingvas Studio AWS ì „ì²´ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨
%% Mermaid í˜•ì‹

flowchart TB
    subgraph Internet["ì¸í„°ë„·"]
        Users["ğŸ‘¥ ì‚¬ìš©ìë“¤"]
        LemonSqueezy["ğŸ’³ Lemon Squeezy<br/>(ê²°ì œ Webhook)"]
    end

    subgraph AWS["â˜ï¸ AWS Cloud (ap-northeast-2)"]
        subgraph Edge["Edge Layer"]
            CloudFront["ğŸŒ CloudFront CDN"]
            WAF["ğŸ›¡ï¸ AWS WAF"]
            Route53["ğŸ“ Route 53<br/>(DNS)"]
        end

        subgraph VPC["VPC (10.0.0.0/16)"]
            subgraph PublicSubnets["Public Subnets"]
                ALB["âš–ï¸ Application<br/>Load Balancer"]
                NAT["ğŸ”„ NAT Gateway"]
                OpenVPN["ğŸ” OpenVPN<br/>Access Server"]
            end

            subgraph PrivateSubnets["Private Subnets"]
                subgraph EKS["âˆ EKS Cluster"]
                    subgraph SystemNodes["System Node Group<br/>(t4g.medium - ARM64)"]
                        NginxIngress["ğŸšª Nginx Ingress"]
                        ArgoCD["ğŸ”„ ArgoCD"]
                        Prometheus["ğŸ“Š Prometheus"]
                    end

                    subgraph DevNamespace["ğŸ“¦ Namespace: pingvas-dev"]
                        DevAPI["ğŸ”§ API Services<br/>(Dev)"]
                        DevRedis["ğŸ’¾ Redis<br/>(Standalone)"]
                    end

                    subgraph ProdNamespace["ğŸ“¦ Namespace: pingvas-prod"]
                        ProdAPI["âš™ï¸ API Services<br/>(Prod)"]
                        ProdRedis["ğŸ’¾ Redis<br/>(Sentinel)"]
                    end

                    subgraph GPUNodes["GPU Node Group<br/>(g4dn.xlarge - Spot via Karpenter)"]
                        AIWorker1["ğŸ¤– AI Worker 1"]
                        AIWorker2["ğŸ¤– AI Worker 2"]
                        AIWorkerN["ğŸ¤– AI Worker N"]
                    end
                end
            end

            subgraph DataLayer["Data Layer"]
                Aurora["ğŸ˜ Aurora PostgreSQL<br/>(db.t3.medium)"]
                EFS["ğŸ“ EFS<br/>(AI Models)"]
            end
        end

        subgraph Storage["Storage Layer"]
            S3Images["ğŸ“· S3 Bucket<br/>(Generated Images)"]
            S3Assets["ğŸ“¦ S3 Bucket<br/>(Static Assets)"]
        end

        subgraph Security["Security & Monitoring"]
            SecretsManager["ğŸ”’ Secrets Manager"]
            CloudWatch["ğŸ“ˆ CloudWatch"]
            IAM["ğŸ‘¤ IAM<br/>(Assume Role)"]
        end
    end

    %% ì—°ê²°ì„ 
    Users --> Route53
    Route53 --> CloudFront
    CloudFront --> WAF
    WAF --> ALB
    LemonSqueezy --> ALB

    ALB --> NginxIngress
    NginxIngress --> DevAPI
    NginxIngress --> ProdAPI

    DevAPI --> DevRedis
    DevAPI --> Aurora
    ProdAPI --> ProdRedis
    ProdAPI --> Aurora

    DevAPI --> S3Images
    ProdAPI --> S3Images

    AIWorker1 --> EFS
    AIWorker2 --> EFS
    AIWorkerN --> EFS
    AIWorker1 --> S3Images
    AIWorker2 --> S3Images
    AIWorkerN --> S3Images

    DevRedis -.-> AIWorker1
    ProdRedis -.-> AIWorker1
    ProdRedis -.-> AIWorker2
    ProdRedis -.-> AIWorkerN

    OpenVPN --> EKS
    OpenVPN --> Aurora

    CloudFront --> S3Assets
    CloudFront --> S3Images

    %% ìŠ¤íƒ€ì¼
    style GPUNodes fill:#ff9999,stroke:#cc0000
    style SystemNodes fill:#99ff99,stroke:#00cc00
    style Aurora fill:#99ccff,stroke:#0066cc
    style EFS fill:#ffcc99,stroke:#cc6600
